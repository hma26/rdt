<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ResearchData ‚Äî Profile</title>
  <link rel="stylesheet" href="css/profile.css">
  <link rel="stylesheet" href="css/home.css">
</head>

<body>
  <!-- Top Navbar -->
  <header class="navbar">
    <div class="nav-container">
      <a href="home.html" class="logo">Research<span>Data</span></a>
      <div class="search">
        <input type="search" placeholder="Search research, people, and publications...">
      </div>
      <nav class="nav-actions">
        <a href="home.html">Home</a>
        <a href="publication.html">Publications</a>
        <a href="proj.html">Projects</a>
        <a href="jobs.html">Jobs</a>
        <a href="msg.html">Messages</a>
        <a href="profile.html" class="active">Profile</a>
        <button id="logout-button" class="btn btn-logout">Logout</button>
      </nav>
    </div>
  </header>

  <!-- Profile Header -->
  <section class="profile-header container">
    <div class="profile-info">
      <div class="online-indicator">
        <img src="avt.png" alt="Dr. Zike Example" class="avatar-lg">
      </div>
      <div>
        <h1 id="user-fullname">Dr. Zike Example</h1>
        <p id="user-affiliation" class="muted">Lincoln University College ‚Äî Internet Technology Dept.</p>
        <p id="user-interests"><strong>Research interests:</strong> Cloud Computing, Security, Web Development</p>
      </div>
    </div>
    <div class="profile-actions">
      <button id="edit-profile-btn" class="btn btn-primary">‚úèÔ∏è Edit Profile</button>
      <button id="save-profile-btn" class="btn btn-primary" style="display: none;">‚úÖ Save Changes</button>
      <button id="cancel-profile-btn" class="btn btn-secondary" style="display: none;">Cancel</button>
    </div>
    <div class="profile-stats">
      <div><strong>1,234</strong><span>Reads</span></div>
      <div><strong>456</strong><span>Citations</span></div>
      <div><strong>78</strong><span>Publications</span></div>
    </div>
  </section>

  <!-- Main Layout -->
  <main class="main-grid container">
    <!-- Column 1: Left Sidebar -->
    <aside class="sidebar-left">
      <!-- MOVE The "About" Card Here -->
      <div class="card">
        <h3>About</h3>
        <p id="user-bio-text">Loading biography...</p>
        <div class="edit-control">
          <button id="edit-bio-button" class="btn ghost" style="margin-top: 1rem;">Edit Bio</button>
        </div>
        <div id="edit-bio-form" style="display: none; margin-top: 1rem;">
          <textarea id="bio-textarea" class="form-textarea" rows="5"></textarea>
          <div class="form-actions" style="margin-top: 1rem; display: flex; gap: 1rem;">
            <button id="save-bio-button" class="btn btn-primary">Save</button>
            <button id="cancel-bio-button" class="btn btn-secondary">Cancel</button>
          </div>
        </div>
      </div>

      <!-- MOVE The "Skills" Card Here -->
      <div class="card">
        <h3>Skills</h3>
        <ul id="user-skills-list" class="skills-list"></ul>
        <div class="edit-control">
          <div class="list-input-container">
            <input type="text" id="skill-input" class="form-input-skill" placeholder="Add a new skill...">
            <button data-list="skills" data-input="skill-input" class="btn btn-add-skill add-list-item-btn">+</button>
          </div>
        </div>
      </div>

      <!-- MOVE The "Recent Activity" Card Here -->
      <div class="card">
        <h3>Recent Activity</h3>
        <ul id="activity-list"></ul>
        <div class="edit-control">
          <div class="list-input-container">
            <input type="text" id="activity-input" class="form-input-skill" placeholder="Add new activity...">
            <button data-list="recentActivity" data-input="activity-input"
              class="btn btn-add-skill add-list-item-btn">+</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Center: Publications -->
    <section id="publications-feed" class="feed">
      <h2>Publications</h2>
      <button id="add-publication-btn" class="btn btn-primary" style="margin-bottom: 1.5rem;">+ Add New
        Publication</button> <!-- The list of publications will be dynamically inserted here -->
    </section>
    <div id="publication-modal" class="modal-overlay" style="display: none;">
      <div class="modal-content" style="text-align: left; max-width: 600px;">
        <!-- Use the same header style as other forms -->
        <div class="form-header" style="text-align: left; margin-bottom: 1.5rem;">
          <h2>Add New Publication</h2>
          <p>Enter the details for your new publication entry.</p>
        </div>

        <form id="publication-form">
          <input type="hidden" id="pub-id">
          <div class="form-group">
            <label for="pub-title" class="form-label required">Title</label>
            <input type="text" id="pub-title" class="form-input" placeholder="e.g., A Novel Approach to..." required>
          </div>

          <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label for="pub-year" class="form-label">Year</label>
              <input type="number" id="pub-year" class="form-input" placeholder="e.g., 2024">
            </div>

            <div class="form-group">
              <label for="pub-classifications-input" class="form-label">Classifications</label>
              <div id="pub-tags-container" class="tag-input-container">
                <input type="text" id="pub-classifications-input" class="form-input-tag"
                  placeholder="Type a classification and press Enter...">
              </div>
              <div id="pub-suggestions-panel" class="suggestions-panel"></div>
            </div>

            <div class="form-group">
              <label for="pub-venue" class="form-label">Journal / Venue</label>
              <input type="text" id="pub-venue" class="form-input" placeholder="e.g., Journal of Cloud Computing">
            </div>
          </div>

          <div class="form-group">
            <label for="pub-abstract" class="form-label">Abstract</label>
            <textarea id="pub-abstract" class="form-textarea" rows="5"
              placeholder="Enter a brief summary of the publication..."></textarea>
          </div>

          <div class="modal-actions" style="justify-content: flex-end; margin-top: 1.5rem;">
            <button type="button" id="cancel-pub-btn" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Publication</button>
          </div>
        </form>
      </div>
    </div>


    <!-- Right Sidebar -->
    <aside class="sidebar-right">
      <!-- MOVE The "Collaborators" Card Here -->
      <div class="card">
        <h3>Collaborators</h3>
        <ul id="collaborators-list"></ul>
        <div class="edit-control">
          <div class="list-input-container">
            <input type="text" id="collaborator-input" class="form-input-skill" placeholder="Add collaborator...">
            <button data-list="collaborators" data-input="collaborator-input"
              class="btn btn-add-skill add-list-item-btn">+</button>
          </div>
        </div>
      </div>

      <!-- MOVE The "Active Projects" Card Here -->
      <div class="card">
        <h3>Active Projects</h3>
        <ul id="projects-list"></ul>
        <div class="edit-control">
          <div class="list-input-container">
            <input type="text" id="project-input" class="form-input-skill" placeholder="Add project...">
            <button data-list="activeProjects" data-input="project-input"
              class="btn btn-add-skill add-list-item-btn">+</button>
          </div>
        </div>
      </div>

      <!-- MOVE The "Achievements" Card Here -->
      <div class="card">
        <h3>Achievements</h3>
        <ul id="achievements-list"></ul>
        <div class="edit-control">
          <div class="list-input-container">
            <input type="text" id="achievement-input" class="form-input-skill" placeholder="Add achievement...">
            <button data-list="achievements" data-input="achievement-input"
              class="btn btn-add-skill add-list-item-btn">+</button>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <p>¬© 2025 ResearchData ‚Äî Connecting researchers worldwide</p>
  </footer>

  <div id="logout-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>Confirm Logout</h3>
      <p>Are you sure you want to log out of your ResearchData account?</p>
      <div class="modal-actions">
        <button id="cancel-logout" class="btn btn-secondary">Cancel</button>
        <button id="confirm-logout" class="btn btn-danger">Log Out</button>
      </div>
    </div>
  </div>

  <script>
    // --- Page Protection (Runs Immediately) ---
    const token = localStorage.getItem('access_token');
    if (!token) {
      alert('Access denied. Please log in.');
      window.location.href = 'login.html';
    }

    // --- Define Global Variables & Functions ---
    let user; // Holds the profile data of the person BEING VIEWED
    let loggedInUser;
    let userPublications = [];
    let isMyProfile = false;

    // We declare the render function globally so our refresh handlers can call it.
    // It will be assigned its real logic inside DOMContentLoaded.
    let renderPublications = (publications) => { };

    // GLOBAL API HELPER (accessible everywhere)
    const apiFetch = async (url, options = {}) => {
      const response = await fetch(`http://localhost:3001${url}`, {
        ...options,
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${token}`,
          ...options.headers,
        },
        cache: 'no-cache'
      });
      if (response.status === 401) {
        alert('Session expired. Please log in again.');
        window.location.href = 'login.html';
      }
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.message || 'An API error occurred.');
      }
      if (response.status !== 204) {
        return await response.json();
      }
      return true;
    };

    // This function will be called by the like/save handlers
    const refreshPublications = async () => {
      const url = isMyProfile ? '/publications/mine' : `/users/${user.id}/publications`;
      try {
        const newPublications = await apiFetch(url);
        userPublications = newPublications;
        renderPublications(userPublications);
      } catch (error) {
        console.error("Failed to refresh publications:", error);
      }
    };

    // GLOBAL INTERACTION HANDLERS (accessible by onclick)
    window.toggleLike = async (pubId, isDislike) => {
      try {
        await apiFetch(`/publications/${pubId}/like`, { method: 'POST', body: JSON.stringify({ isDislike }) });
        await refreshPublications();
      } catch (error) {
        console.error('Failed to toggle like:', error);
        alert('Action failed. Please try again.');
      }
    };

    window.toggleSave = async (pubId) => {
      try {
        await apiFetch(`/publications/${pubId}/save`, { method: 'POST' });
        await refreshPublications();
      } catch (error) {
        console.error('Failed to toggle save:', error);
        alert('Action failed. Please try again.');
      }
    };

    window.openComments = (pubId) => {
      alert(`Comments for publication ID: ${pubId} coming soon!`);
    };

    // --- Main Application Logic ---
    document.addEventListener('DOMContentLoaded', async () => {
      let originalUser;
      let isEditMode = false;

      // --- Get all DOM element references ---
      const mainEditBtn = document.getElementById('edit-profile-btn');
      const saveProfileBtn = document.getElementById('save-profile-btn');
      const cancelProfileBtn = document.getElementById('cancel-profile-btn');
      const fullNameEl = document.getElementById('user-fullname');
      const affiliationEl = document.getElementById('user-affiliation');
      const interestsEl = document.getElementById('user-interests');
      const bioTextEl = document.getElementById('user-bio-text');
      const editBioBtn = document.getElementById('edit-bio-button');
      const editBioForm = document.getElementById('edit-bio-form');
      const bioTextarea = document.getElementById('bio-textarea');
      const saveBioBtn = document.getElementById('save-bio-button');
      const cancelBioBtn = document.getElementById('cancel-bio-button');
      const publicationsFeedEl = document.getElementById('publications-feed');
      const addPubBtn = document.getElementById('add-publication-btn');
      const pubModal = document.getElementById('publication-modal');
      const pubForm = document.getElementById('publication-form');
      const cancelPubBtn = document.getElementById('cancel-pub-btn');
      const pubIdInput = document.getElementById('pub-id');
      const pubTitleInput = document.getElementById('pub-title');
      const pubYearInput = document.getElementById('pub-year');
      const pubVenueInput = document.getElementById('pub-venue');
      const pubAbstractInput = document.getElementById('pub-abstract');
      const pubModalTitle = pubModal.querySelector('h2');
      const classificationInput = document.getElementById('pub-classifications-input');
      const tagsContainer = document.getElementById('pub-tags-container');
      const suggestionsPanel = document.getElementById('pub-suggestions-panel');

      // --- EDIT MODE CONTROLS ---
      const toggleEditMode = (isEditing) => {
        isEditMode = isEditing;
        document.body.classList.toggle('edit-mode', isEditing);
        mainEditBtn.style.display = isEditing ? 'none' : 'inline-flex';
        saveProfileBtn.style.display = isEditing ? 'inline-flex' : 'none';
        cancelProfileBtn.style.display = isEditing ? 'inline-flex' : 'none';
        renderBio(user);
        renderAllLists();
      };

      // --- RENDER FUNCTIONS ---
      const renderProfileInfo = (currentUser) => {
        fullNameEl.textContent = `${currentUser.firstName} ${currentUser.lastName}`;
        affiliationEl.textContent = `${currentUser.institution || 'No Institution'} ‚Äî ${currentUser.department || 'No Department'}`;
        const interestsText = (currentUser.interests || []).length > 0 ? currentUser.interests.join(', ') : 'No interests listed.';
        interestsEl.innerHTML = `<strong>Research interests:</strong> ${interestsText}`;
      };

      const renderBio = (currentUser) => {
        bioTextEl.textContent = currentUser.bio || 'No biography provided yet.';
        editBioBtn.parentElement.style.display = isMyProfile && isEditMode ? 'block' : 'none';
      };

      const listsConfig = [{ key: 'skills', listId: 'user-skills-list' }, { key: 'recentActivity', listId: 'activity-list' }, { key: 'collaborators', listId: 'collaborators-list' }, { key: 'activeProjects', listId: 'projects-list' }, { key: 'achievements', listId: 'achievements-list' }];
      const renderList = (config) => {
        const listEl = document.getElementById(config.listId);
        const items = user[config.key] || [];
        listEl.innerHTML = '';
        if (items.length > 0) {
          items.forEach(itemText => {
            const li = document.createElement('li');
            li.innerHTML = `<span>${itemText}</span>`;
            if (isMyProfile && isEditMode) {
              const removeBtn = document.createElement('button');
              removeBtn.className = 'remove-skill-btn';
              removeBtn.innerHTML = '&times;';
              removeBtn.onclick = () => { user[config.key] = user[config.key].filter(i => i !== itemText); renderAllLists(); };
              li.appendChild(removeBtn);
            }
            listEl.appendChild(li);
          });
        } else {
          const keyName = config.key.replace(/([A-Z])/g, ' $1').toLowerCase();
          listEl.innerHTML = `<p style="color: var(--text-tertiary); font-size: 0.9rem;">No ${keyName} added yet.</p>`;
        }
      };
      const renderAllLists = () => {
        // This function's only job is to render the list items (the pills).
        // It should NOT be responsible for showing or hiding the input forms.
        // Our CSS now handles that automatically based on the 'edit-mode' body class.
        listsConfig.forEach(renderList);
      };

      // Assign the logic to the globally declared renderPublications function
      renderPublications = (publications) => {
        publicationsFeedEl.querySelectorAll('.feed-item, .no-pubs-message').forEach(el => el.remove());
        addPubBtn.style.display = isMyProfile ? 'inline-flex' : 'none';

        if (publications && publications.length > 0) {
          publications.forEach(pub => {
            const createdAt = new Date(pub.createdAt).toLocaleDateString();
            const updatedAt = new Date(pub.updatedAt).toLocaleDateString();
            const classificationsHTML = (pub.classifications || []).map(c => `<span class="tag">${c}</span>`).join('');

            const userLike = pub.likes && pub.likes[0];
            const isLiked = userLike && !userLike.isDislike;
            const isSaved = pub.saves && pub.saves.length > 0;

            const likeCount = pub._count.likes || 0;
            const commentCount = pub._count.comments || 0;
            const saveCount = pub._count.saves || 0;

            const editButtonHTML = isMyProfile ? `<button class="edit-pub-btn" data-pub-id="${pub.id}">‚úèÔ∏è Edit</button>` : '';

            const likeIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M14 9V5a3 3 0 0 0-3-3l-4 9v11h11.28a2 2 0 0 0 2-1.7l1.38-9a2 2 0 0 0-2-2.3zM7 22H4a2 2 0 0 1-2-2v-7a2 2 0 0 1 2-2h3"></path></svg>`;
            const commentIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>`;
            const saveIcon = `<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M19 21l-7-5-7 5V5a2 2 0 0 1 2-2h10a2 2 0 0 1 2 2z"></path></svg>`;

            const pubHTML = `
                <article class="card feed-item" data-pub-id="${pub.id}">
                    <div class="feed-item-header">
                        <h4>${pub.title}</h4>
                        ${editButtonHTML}
                    </div>
                    <p class="muted">Published in ${pub.venue || 'N/A'} ‚Ä¢ ${pub.year || 'N/A'}</p>
                    <div class="tags-container" style="margin-bottom: 1rem;">${classificationsHTML}</div>
                    <p>${pub.abstract || 'No abstract available.'}</p>
                    <div class="timestamps">Created: ${createdAt} | Last Updated: ${updatedAt}</div>
                    
                    <div class="feed-footer">
                        <button class="btn ghost like-btn ${isLiked ? 'active' : ''}" onclick="toggleLike('${pub.id}', false)">
                            ${likeIcon} Like (${likeCount})
                        </button>
                        
                        <!-- dislike button position -->
                        
                        <button class="btn ghost" onclick="openComments('${pub.id}')">
                            ${commentIcon} Comment (${commentCount})
                        </button>
                        
                        <!-- 2. UPDATE THE SAVE BUTTON -->
                        <button class="btn ghost save-btn ${isSaved ? 'active' : ''}" onclick="toggleSave('${pub.id}')">
                            ${saveIcon} ${isSaved ? `Saved (${saveCount})` : `Save (${saveCount})`}
                        </button>
                    </div>
                </article>`;
            publicationsFeedEl.insertAdjacentHTML('beforeend', pubHTML);
          });
        } else {
          const noPubsMessage = document.createElement('p');
          noPubsMessage.className = 'no-pubs-message';
          noPubsMessage.textContent = "You haven't added any publications yet.";
          publicationsFeedEl.appendChild(noPubsMessage);
        }
      };

      // --- <!-- <button class="btn ghost dislike-btn ${isDisliked ? 'active' : ''}" onclick="toggleLike('${pub.id}', true)">üëé</button> --> ---
      try {
        // --- INITIAL PAGE LOAD ---
        // --- publicationsFeedEl.insertAdjacentHTML('beforeend', pubHTML); ---
        const urlParams = new URLSearchParams(window.location.search);
        const profileId = urlParams.get('id');

        loggedInUser = await apiFetch('/profile/me');

        if (profileId && profileId !== loggedInUser.id) {
          isMyProfile = false;
          user = await apiFetch(`/users/${profileId}`);
          try {
            // This will fail until the backend endpoint exists, but the catch handles it
            userPublications = await apiFetch(`/users/${profileId}/publications`);
          } catch (e) {
            console.warn(`Could not fetch publications for user ${profileId}.`);
            userPublications = [];
          }
        } else {
          isMyProfile = true;
          user = loggedInUser;
          userPublications = await apiFetch('/publications/mine');
        }

        originalUser = JSON.parse(JSON.stringify(user));
        renderProfileInfo(user);
        renderPublications(userPublications);
        renderBio(user);
        renderAllLists();

        // --- SETUP EVENT LISTENERS (ONLY IF IT'S MY PROFILE) ---
        if (isMyProfile) {
          mainEditBtn.addEventListener('click', () => { originalUser = JSON.parse(JSON.stringify(user)); toggleEditMode(true); });
          cancelProfileBtn.addEventListener('click', () => { user = JSON.parse(JSON.stringify(originalUser)); toggleEditMode(false); });
          saveProfileBtn.addEventListener('click', async () => {
            const dataToSave = { bio: user.bio, skills: user.skills, recentActivity: user.recentActivity, collaborators: user.collaborators, activeProjects: user.activeProjects, achievements: user.achievements };
            try {
              const response = await apiFetch('/profile/me', { method: 'PATCH', body: JSON.stringify(dataToSave) });
              user = response;
              originalUser = JSON.parse(JSON.stringify(user));
              toggleEditMode(false);
              alert('Profile saved successfully!');
            } catch (error) {
              alert('Could not save profile.'); console.error(error);
            }
          });
          const hideBioForm = () => { editBioForm.style.display = 'none'; bioTextEl.style.display = 'block'; editBioBtn.parentElement.style.display = 'block'; };
          editBioBtn.addEventListener('click', () => { editBioForm.style.display = 'block'; bioTextEl.style.display = 'none'; editBioBtn.parentElement.style.display = 'none'; bioTextarea.value = user.bio || ''; bioTextarea.focus(); });
          cancelBioBtn.addEventListener('click', () => { renderBio(user); hideBioForm(); });
          saveBioBtn.addEventListener('click', () => { user.bio = bioTextarea.value; renderBio(user); hideBioForm(); });
          document.querySelectorAll('.add-list-item-btn').forEach(button => {
            const listKey = button.dataset.list;
            const inputId = button.dataset.input;
            const inputEl = document.getElementById(inputId);
            const addItem = () => { const newItem = inputEl.value.trim(); if (newItem && !(user[listKey] || []).includes(newItem)) { user[listKey] = [...(user[listKey] || []), newItem]; renderAllLists(); inputEl.value = ''; } };
            button.addEventListener('click', addItem);
            inputEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); addItem(); } });
          });
          let editingPublicationId = null;
          let selectedClassifications = [];
          const allClassifications = ['Artificial Intelligence', 'Robotics', 'Computer Science', 'Machine Learning', 'Data Science', 'Quantum Computing', 'Bioinformatics', 'Medicine', 'Physics', 'Chemistry', 'Mathematics', 'Engineering', 'Economics', 'Sociology'];
          const renderClassificationTags = () => { tagsContainer.querySelectorAll('.tag').forEach(tagEl => tagEl.remove()); selectedClassifications.forEach(tag => { const tagEl = document.createElement('div'); tagEl.className = 'tag'; tagEl.innerHTML = `<span>${tag}</span><button type="button" class="remove-tag">&times;</button>`; tagEl.querySelector('.remove-tag').onclick = () => { selectedClassifications = selectedClassifications.filter(t => t !== tag); renderClassificationTags(); }; tagsContainer.insertBefore(tagEl, classificationInput); }); };
          const addClassificationTag = (tag) => { if (tag && !selectedClassifications.includes(tag)) { selectedClassifications.push(tag); renderClassificationTags(); } classificationInput.value = ''; suggestionsPanel.style.display = 'none'; };
          classificationInput.addEventListener('input', () => { const query = classificationInput.value.toLowerCase(); suggestionsPanel.innerHTML = ''; if (query.length > 0) { const filtered = allClassifications.filter(c => c.toLowerCase().includes(query) && !selectedClassifications.includes(c)); if (filtered.length > 0) { filtered.forEach(item => { const div = document.createElement('div'); div.className = 'suggestion-item'; div.textContent = item; div.onclick = () => addClassificationTag(item); suggestionsPanel.appendChild(div); }); suggestionsPanel.style.display = 'block'; } else { suggestionsPanel.style.display = 'none'; } } else { suggestionsPanel.style.display = 'none'; } });
          classificationInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && classificationInput.value) { e.preventDefault(); addClassificationTag(classificationInput.value); } });
          const showPublicationModal = () => { pubModal.style.display = 'flex'; setTimeout(() => { pubModal.style.opacity = '1'; pubModal.querySelector('.modal-content').style.transform = 'scale(1)'; }, 10); };
          const hidePublicationModal = () => { pubModal.style.opacity = '0'; pubModal.querySelector('.modal-content').style.transform = 'scale(0.95)'; setTimeout(() => { pubModal.style.display = 'none'; pubForm.reset(); selectedClassifications = []; renderClassificationTags(); }, 300); };
          const openAddModal = () => { editingPublicationId = null; pubModalTitle.textContent = 'Add New Publication'; pubForm.reset(); selectedClassifications = []; renderClassificationTags(); pubYearInput.value = new Date().getFullYear(); showPublicationModal(); };
          const openEditModal = (pubId) => { editingPublicationId = pubId; const pub = userPublications.find(p => p.id === pubId); if (!pub) return; pubModalTitle.textContent = 'Edit Publication'; pubIdInput.value = pub.id; pubTitleInput.value = pub.title; pubYearInput.value = pub.year; pubVenueInput.value = pub.venue; pubAbstractInput.value = pub.abstract; selectedClassifications = [...(pub.classifications || [])]; renderClassificationTags(); showPublicationModal(); };
          publicationsFeedEl.addEventListener('click', (event) => { const btn = event.target.closest('.edit-pub-btn'); if (btn) openEditModal(btn.dataset.pubId); });
          addPubBtn.addEventListener('click', openAddModal);
          cancelPubBtn.addEventListener('click', hidePublicationModal);
          pubForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const pubData = { title: pubTitleInput.value, year: parseInt(pubYearInput.value) || null, venue: pubVenueInput.value, abstract: pubAbstractInput.value, classifications: selectedClassifications };
            const method = editingPublicationId ? 'PATCH' : 'POST';
            const url = editingPublicationId ? `/publications/${editingPublicationId}` : '/publications';
            try {
              await apiFetch(url, { method, body: JSON.stringify(pubData) });
              hidePublicationModal();
              await refreshPublications();
            } catch (error) {
              alert('Could not save publication.');
            }
          });
        } else {
          mainEditBtn.innerHTML = '‚úâÔ∏è Send Message';
          mainEditBtn.onclick = () => alert(`Messaging feature for ${user.firstName} is coming soon!`);
          saveProfileBtn.style.display = 'none';
          cancelProfileBtn.style.display = 'none';
        }
      } catch (error) {
        console.error('Failed to load profile:', error);
        alert('Could not load profile. It may not exist or there was an error.');
        window.location.href = 'home.html';
      }
    });

    // --- LOGOUT MODAL LOGIC ---
    const logoutButton = document.getElementById('logout-button');
    const logoutModal = document.getElementById('logout-modal');
    const cancelLogoutButton = document.getElementById('cancel-logout');
    const confirmLogoutButton = document.getElementById('confirm-logout');
    logoutButton.addEventListener('click', () => { logoutModal.style.display = 'flex'; setTimeout(() => { logoutModal.style.opacity = '1'; logoutModal.querySelector('.modal-content').style.transform = 'scale(1)'; }, 10); });
    const hideModal = () => { logoutModal.style.opacity = '0'; logoutModal.querySelector('.modal-content').style.transform = 'scale(0.95)'; setTimeout(() => { logoutModal.style.display = 'none'; }, 300); };
    cancelLogoutButton.addEventListener('click', hideModal);
    confirmLogoutButton.addEventListener('click', () => { localStorage.removeItem('access_token'); window.location.href = 'index.html'; });
    logoutModal.addEventListener('click', (event) => { if (event.target === logoutModal) { hideModal(); } });
  </script>
</body>

</html>