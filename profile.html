<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>ResearchData — Profile</title>

  <link rel="stylesheet" href="css/profile.css">
  

</head>

<body>
  <!-- Top Navbar -->
  <header class="navbar">
    <div class="nav-container">
      <a href="home.html" class="logo">Research<span>Data</span></a>
      <div class="search">
        <input type="search" placeholder="Search research, people, and publications...">
      </div>
      <nav class="nav-actions">
        <a href="home.html">Home</a>
        <a href="publication.html">Publications</a>
        <a href="proj.html">Projects</a>
        <a href="jobs.html">Jobs</a>
        <a href="msg.html">Messages</a>
        <a href="profile.html" class="active">Profile</a>
        <button id="logout-button" class="btn btn-logout">Logout</button>
      </nav>
    </div>
  </header>

  <!-- Profile Header -->
  <section class="profile-header container">
    <div class="profile-info">
      <div class="online-indicator">
        <img src="avt.png" alt="Dr. Zike Example" class="avatar-lg">
      </div>
      <div>
        <h1 id="user-fullname">Dr. Zike Example</h1>
        <p id="user-affiliation" class="muted">Lincoln University College — Internet Technology Dept.</p>
        <p id="user-interests"><strong>Research interests:</strong> Cloud Computing, Security, Web Development</p>
      </div>
    </div>
    <div class="profile-stats">
      <div><strong>1,234</strong><span>Reads</span></div>
      <div><strong>456</strong><span>Citations</span></div>
      <div><strong>78</strong><span>Publications</span></div>
    </div>
  </section>

  <!-- Main Layout -->
  <main class="main-grid container">
    <!-- Left Sidebar -->
    <aside class="sidebar-left">
      <div class="card">
        <h3>About</h3>
        <p id="user-bio-text">Loading biography...</p>
        <button id="edit-bio-button" class="btn ghost" style="margin-top: 1rem;">Edit Bio</button>
        <div id="edit-bio-form" style="display: none; margin-top: 1rem;">
          <textarea id="bio-textarea" class="form-textarea" rows="5"></textarea>
          <div class="form-actions" style="margin-top: 1rem; display: flex; gap: 1rem;">
            <button id="save-bio-button" class="btn">Save</button>
            <button id="cancel-bio-button" class="btn ghost">Cancel</button>
          </div>
        </div>
      </div>
      <div class="card">
        <h3>Skills</h3>
        <ul id="user-skills-list" class="skills-list">
        </ul>
        <div class="skill-input-container" style="margin-top: 1.5rem;">
          <input type="text" id="skill-input" class="form-input-skill" placeholder="Add a new skill...">
          <!-- This is the new, correct button with the data attributes -->
          <button data-list="skills" data-input="skill-input" class="btn btn-add-skill add-list-item-btn">+</button>
        </div>
      </div>
      <div class="card">
        <h3>Recent Activity</h3>
        <ul id="activity-list">
        </ul>
        <div class="list-input-container">
          <input type="text" id="activity-input" class="form-input-skill" placeholder="Add new activity...">
          <button data-list="recentActivity" data-input="activity-input"
            class="btn btn-add-skill add-list-item-btn">+</button>
        </div>
      </div>
    </aside>

    <!-- Center: Publications -->
    <section id="publications-feed" class="feed">
      <h2>Publications</h2>
      <button id="add-publication-btn" class="btn btn-primary" style="margin-bottom: 1.5rem;">+ Add New
        Publication</button> <!-- The list of publications will be dynamically inserted here -->
    </section>
    <div id="publication-modal" class="modal-overlay" style="display: none;">
      <div class="modal-content" style="text-align: left; max-width: 600px;">
        <!-- Use the same header style as other forms -->
        <div class="form-header" style="text-align: left; margin-bottom: 1.5rem;">
          <h2>Add New Publication</h2>
          <p>Enter the details for your new publication entry.</p>
        </div>

        <form id="publication-form">
          <div class="form-group">
            <label for="pub-title" class="form-label required">Title</label>
            <input type="text" id="pub-title" class="form-input" placeholder="e.g., A Novel Approach to..." required>
          </div>

          <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div class="form-group">
              <label for="pub-year" class="form-label">Year</label>
              <input type="number" id="pub-year" class="form-input" placeholder="e.g., 2024">
            </div>
            <div class="form-group">
              <label for="pub-venue" class="form-label">Journal / Venue</label>
              <input type="text" id="pub-venue" class="form-input" placeholder="e.g., Journal of Cloud Computing">
            </div>
          </div>

          <div class="form-group">
            <label for="pub-abstract" class="form-label">Abstract</label>
            <textarea id="pub-abstract" class="form-textarea" rows="5"
              placeholder="Enter a brief summary of the publication..."></textarea>
          </div>

          <div class="modal-actions" style="justify-content: flex-end; margin-top: 1.5rem;">
            <button type="button" id="cancel-pub-btn" class="btn btn-secondary">Cancel</button>
            <button type="submit" class="btn btn-primary">Save Publication</button>
          </div>
        </form>
      </div>
    </div>

    <!-- Right Sidebar -->
    <aside class="sidebar-right">
      <div class="card">
        <h3>Collaborators</h3>
        <ul id="collaborators-list">
        </ul>
        <div class="list-input-container">
          <input type="text" id="collaborator-input" class="form-input-skill" placeholder="Add collaborator...">
          <button data-list="collaborators" data-input="collaborator-input"
            class="btn btn-add-skill add-list-item-btn">+</button>
        </div>
      </div>
      <div class="card">
        <h3>Active Projects</h3>
        <ul id="projects-list">
        </ul>
        <div class="list-input-container">
          <input type="text" id="project-input" class="form-input-skill" placeholder="Add project...">
          <button data-list="activeProjects" data-input="project-input"
            class="btn btn-add-skill add-list-item-btn">+</button>
        </div>
      </div>
      <div class="card">
        <h3>Achievements</h3>
        <ul id="achievements-list">
        </ul>
        <div class="list-input-container">
          <input type="text" id="achievement-input" class="form-input-skill" placeholder="Add achievement...">
          <button data-list="achievements" data-input="achievement-input"
            class="btn btn-add-skill add-list-item-btn">+</button>
        </div>
      </div>
    </aside>
  </main>

  <!-- Footer -->
  <footer class="footer">
    <p>© 2025 ResearchData — Connecting researchers worldwide</p>
  </footer>

  <div id="logout-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
      <h3>Confirm Logout</h3>
      <p>Are you sure you want to log out of your ResearchData account?</p>
      <div class="modal-actions">
        <button id="cancel-logout" class="btn btn-secondary">Cancel</button>
        <button id="confirm-logout" class="btn btn-danger">Log Out</button>
      </div>
    </div>
  </div>

  <script>
    // --- Page Protection (Runs Immediately) ---
    const token = localStorage.getItem('access_token');
    if (!token) {
      alert('Access denied. Please log in.');
      window.location.href = 'login.html';
    }

    // --- Main Application Logic (Runs after HTML is loaded) ---
    document.addEventListener('DOMContentLoaded', async () => {
      let user; // This will hold our main user object, accessible throughout this block

      // Get references to all DOM elements we'll interact with ONCE at the top
      const fullNameEl = document.getElementById('user-fullname');
      const affiliationEl = document.getElementById('user-affiliation');
      const interestsEl = document.getElementById('user-interests');
      const bioTextEl = document.getElementById('user-bio-text');
      const editBioBtn = document.getElementById('edit-bio-button');
      const editBioForm = document.getElementById('edit-bio-form');
      const bioTextarea = document.getElementById('bio-textarea');
      const saveBioBtn = document.getElementById('save-bio-button');
      const cancelBioBtn = document.getElementById('cancel-bio-button');
      const skillsListEl = document.getElementById('user-skills-list');
      const skillInput = document.getElementById('skill-input');
      const addSkillBtn = document.getElementById('add-skill-button');
      const publicationsFeedEl = document.getElementById('publications-feed');
      const addPubBtn = document.getElementById('add-publication-btn');
      const pubModal = document.getElementById('publication-modal');
      const pubForm = document.getElementById('publication-form');
      const cancelPubBtn = document.getElementById('cancel-pub-btn');

      try {
        // --- 1. DEFINE DATA FETCHING FUNCTIONS ---
        const fetchUserData = async () => {
          const response = await fetch('http://localhost:3001/profile/me', {
            headers: { 'Authorization': `Bearer ${token}` },
            cache: 'no-cache'
          });
          if (!response.ok) throw new Error('Could not fetch user profile.');
          return await response.json();
        };

        const fetchUserPublications = async () => {
          const response = await fetch('http://localhost:3001/publications/mine', {
            headers: { 'Authorization': `Bearer ${token}` },
            cache: 'no-cache'
          });
          if (!response.ok) throw new Error('Could not fetch user publications.');
          return await response.json();
        };

        // --- 2. DEFINE RENDER FUNCTIONS ---

        // Renders the top profile section
        const renderProfileInfo = (currentUser) => {
          fullNameEl.textContent = `${currentUser.firstName} ${currentUser.lastName}`;
          affiliationEl.textContent = `${currentUser.institution || 'No Institution'} — ${currentUser.department || 'No Department'}`;
          const interestsText = currentUser.interests.length > 0 ? currentUser.interests.join(', ') : 'No interests listed.';
          interestsEl.innerHTML = `<strong>Research interests:</strong> ${interestsText}`;
        };

        // Renders the bio section
        const renderBio = (currentUser) => {
          if (currentUser.bio) {
            bioTextEl.textContent = currentUser.bio;
            editBioBtn.textContent = 'Edit Bio';
          } else {
            bioTextEl.textContent = 'No biography provided yet.';
            editBioBtn.textContent = 'Add Bio';
          }
        };

        // Renders the skills section
        const renderSkills = () => {
          skillsListEl.innerHTML = '';
          if (user.skills && user.skills.length > 0) {
            user.skills.forEach(skill => {
              const li = document.createElement('li');
              li.textContent = skill;
              const removeBtn = document.createElement('button');
              removeBtn.className = 'remove-skill-btn';
              removeBtn.innerHTML = '&times;';
              removeBtn.onclick = () => removeSkill(skill);
              li.appendChild(removeBtn);
              skillsListEl.appendChild(li);
            });
          } else {
            skillsListEl.innerHTML = '<li>Click below to add your first skill!</li>';
          }
        };

        // Renders the publications section
        const renderPublications = (publications) => {
          const existingContent = publicationsFeedEl.querySelectorAll('.feed-item, .no-pubs-message');
          existingContent.forEach(el => el.remove());

          if (publications.length > 0) {
            publications.forEach(pub => {
              const pubHTML = `
                            <article class="card feed-item">
                                <h4>${pub.title}</h4>
                                <p class="muted">Published in ${pub.venue || 'N/A'} • ${pub.year || 'N/A'}</p>
                                <p>${pub.abstract || 'No abstract available.'}</p>
                            </article>`;
              publicationsFeedEl.insertAdjacentHTML('beforeend', pubHTML);
            });
          } else {
            const noPubsMessage = document.createElement('p');
            noPubsMessage.className = 'no-pubs-message';
            noPubsMessage.textContent = "You haven't added any publications yet.";
            publicationsFeedEl.appendChild(noPubsMessage);
          }
        };

        // --- 3. FETCH INITIAL DATA & RENDER PAGE ---
        const [userData, publicationsData] = await Promise.all([
          fetchUserData(),
          fetchUserPublications()
        ]);
        user = userData; // Assign to the main variable

        renderProfileInfo(user);
        renderBio(user);
        renderSkills();
        renderPublications(publicationsData);

        // --- 4. SETUP EVENT LISTENERS & HANDLERS ---

        // BIO LOGIC
        const hideBioForm = () => {
          editBioForm.style.display = 'none';
          bioTextEl.style.display = 'block';
          editBioBtn.style.display = 'inline-block';
        };
        editBioBtn.addEventListener('click', () => {
          editBioForm.style.display = 'block';
          bioTextEl.style.display = 'none';
          editBioBtn.style.display = 'none';
          bioTextarea.value = user.bio || '';
          bioTextarea.focus();
        });
        cancelBioBtn.addEventListener('click', hideBioForm);
        saveBioBtn.addEventListener('click', async () => {
          const response = await fetch('http://localhost:3001/profile/me', {
            method: 'PATCH',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify({ bio: bioTextarea.value })
          });
          if (!response.ok) return alert('Failed to save bio.');
          user = await response.json(); // Update user object
          renderBio(user);
          hideBioForm();
        });

        // SKILLS LOGIC
        const listsConfig = [
          { key: 'skills', listId: 'user-skills-list', inputId: 'skill-input' },
          { key: 'recentActivity', listId: 'activity-list', inputId: 'activity-input' },
          { key: 'collaborators', listId: 'collaborators-list', inputId: 'collaborator-input' },
          { key: 'activeProjects', listId: 'projects-list', inputId: 'project-input' },
          { key: 'achievements', listId: 'achievements-list', inputId: 'achievement-input' }
        ];

        // Generic function to save any list back to the server
        const saveList = async (listKey, newItems) => {
          try {
            const response = await fetch('http://localhost:3001/profile/me', {
              method: 'PATCH',
              headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
              body: JSON.stringify({ [listKey]: newItems }) // e.g., { skills: [...] }
            });
            if (!response.ok) throw new Error(`Failed to save ${listKey}.`);

            user = await response.json(); // Update the global user object
            renderAllLists(); // Re-render all lists to stay in sync

          } catch (error) {
            console.error(error);
            alert(`Could not save ${listKey}.`);
          }
        };

        // Generic function to render a single list
        const renderList = (config) => {
          const listEl = document.getElementById(config.listId);
          const items = user[config.key] || [];
          listEl.innerHTML = '';

          if (items.length > 0) {
            items.forEach(itemText => {
              const li = document.createElement('li');
              // The key difference is that we are adding the text inside a span,
              // and the button is a sibling, allowing flexbox to work correctly.
              li.innerHTML = `<span>${itemText}</span>`;

              const removeBtn = document.createElement('button');
              removeBtn.className = 'remove-skill-btn';
              removeBtn.innerHTML = '&times;';
              removeBtn.onclick = () => {
                const updatedItems = user[config.key].filter(i => i !== itemText);
                saveList(config.key, updatedItems);
              };

              li.appendChild(removeBtn);
              listEl.appendChild(li);
            });
          } else {
            // A more generic message
            const keyName = config.key.replace(/([A-Z])/g, ' $1').toLowerCase();
            // Use a simple paragraph for the empty message instead of an <li>
            listEl.innerHTML = `<p style="color: var(--text-tertiary); font-size: 0.9rem;">No ${keyName} added yet.</p>`;
          }
        };

        // Function to render all configured lists
        const renderAllLists = () => {
          listsConfig.forEach(renderList);
        };

        // Set up event listeners for all "Add" buttons and inputs
        document.querySelectorAll('.add-list-item-btn').forEach(button => {
          const listKey = button.dataset.list;
          const inputId = button.dataset.input;
          const inputEl = document.getElementById(inputId);

          const addItem = () => {
            const newItem = inputEl.value.trim();
            const currentItems = user[listKey] || [];
            if (newItem && !currentItems.includes(newItem)) {
              saveList(listKey, [...currentItems, newItem]);
              inputEl.value = '';
            }
          };

          button.addEventListener('click', addItem);
          inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
              e.preventDefault();
              addItem();
            }
          });
        });

        // Initial render of all lists when the page loads
        renderAllLists();

        // PUBLICATIONS LOGIC
        const showPublicationModal = () => {
          document.getElementById('pub-year').value = new Date().getFullYear();

          // Always get a fresh reference inside the function to be safe
          const modal = document.getElementById('publication-modal');
          if (modal) {
            modal.style.display = 'flex';
            setTimeout(() => {
              modal.style.opacity = '1';
              modal.querySelector('.modal-content').style.transform = 'scale(1)';
            }, 10);
          }
        };

        const hidePublicationModal = () => {
          const modal = document.getElementById('publication-modal');
          const form = document.getElementById('publication-form');
          if (modal && form) {
            modal.style.opacity = '0';
            modal.querySelector('.modal-content').style.transform = 'scale(0.95)';
            setTimeout(() => {
              modal.style.display = 'none';
              form.reset();
            }, 300);
          }
        };

        addPubBtn.addEventListener('click', showPublicationModal);
        cancelPubBtn.addEventListener('click', hidePublicationModal);

        pubForm.addEventListener('submit', async (e) => {
          e.preventDefault();
          const pubData = {
            title: document.getElementById('pub-title').value,
            year: parseInt(document.getElementById('pub-year').value) || null,
            venue: document.getElementById('pub-venue').value,
            abstract: document.getElementById('pub-abstract').value,
          };
          const response = await fetch('http://localhost:3001/publications', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
            body: JSON.stringify(pubData)
          });
          if (!response.ok) return alert('Failed to save publication.');

          const newPublications = await fetchUserPublications();
          renderPublications(newPublications);
          hidePublicationModal();
        });

      } catch (error) {
        console.error('Failed to load profile:', error);
        alert('Session expired or failed to load data. Please log in again.');
        window.location.href = 'login.html';
      }
    });

    // --- LOGOUT MODAL LOGIC (can stay outside) ---
    const logoutButton = document.getElementById('logout-button');
    const logoutModal = document.getElementById('logout-modal');
    const cancelLogoutButton = document.getElementById('cancel-logout');
    const confirmLogoutButton = document.getElementById('confirm-logout');

    logoutButton.addEventListener('click', () => {
      logoutModal.style.display = 'flex';
      setTimeout(() => {
        logoutModal.style.opacity = '1';
        logoutModal.querySelector('.modal-content').style.transform = 'scale(1)';
      }, 10);
    });

    const hideModal = () => {
      logoutModal.style.opacity = '0';
      logoutModal.querySelector('.modal-content').style.transform = 'scale(0.95)';
      setTimeout(() => {
        logoutModal.style.display = 'none';
      }, 300);
    };

    cancelLogoutButton.addEventListener('click', hideModal);

    confirmLogoutButton.addEventListener('click', () => {
      localStorage.removeItem('access_token');
      window.location.href = 'index.html';
    });

    logoutModal.addEventListener('click', (event) => {
      if (event.target === logoutModal) {
        hideModal();
      }
    });
  </script>
</body>

</html>